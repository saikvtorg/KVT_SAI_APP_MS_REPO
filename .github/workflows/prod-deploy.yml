name: CI - Build and (optional) deploy to Azure (prod)

on:
  push:
    branches:
      - prod

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: Build JAR (prod)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build (Maven)
        run: mvn -B -DskipTests package -Dspring.profiles.active=prod

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar
          path: target/*.jar

  deploy:
    name: Deploy to Azure Web App
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && contains(github.ref, 'refs/heads/prod')
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: jar
          path: target

      # NOTE: App Service application settings are expected to be pre-configured in Azure.
      # The workflow will not modify runtime app settings. Ensure SPRING_PROFILES_ACTIVE=prod and
      # DB-related settings (AZURE_SQL_*) are set in the App Service configuration.

      - name: Deploy to Azure Web App using publish profile
        uses: Azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME_PROD }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE_PROD }}
          package: target/*.jar

      # Optional: run SQL migrations using Flyway (Maven plugin) if you choose to enable it here
      # - name: Run Flyway migrations (optional)
      #   env:
      #     FLYWAY_URL: jdbc:sqlserver://${{ secrets.AZURE_SQL_SERVER }}:1433;database=${{ secrets.AZURE_SQL_DB }}
      #     FLYWAY_USER: ${{ secrets.AZURE_SQL_ADMIN_USER }}
      #     FLYWAY_PASSWORD: ${{ secrets.AZURE_SQL_PASSWORD }}
      #   run: |
      #     mvn -B org.flywaydb:flyway-maven-plugin:migrate \
      #       -Dflyway.url="$FLYWAY_URL" \
      #       -Dflyway.user="$FLYWAY_USER" \
      #       -Dflyway.password="$FLYWAY_PASSWORD" \
      #       -Dflyway.locations=filesystem:src/main/resources/db/migration/canonical

    # You must configure the required secrets in the repository: AZURE_WEBAPP_NAME_PROD and AZURE_WEBAPP_PUBLISH_PROFILE_PROD
    # (and the Flyway/DB secrets if you enable migrations above).
